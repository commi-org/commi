name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v2.x

      - name: Install SQLite3
        run: sudo apt-get update && sudo apt-get install -y sqlite3

      - name: Prepare GoToSocial Data Directory
        run: |
          mkdir -p gotosocial_data
          chmod 777 gotosocial_data

      - name: Start GoToSocial
        run: docker compose up -d

      - name: Wait for GoToSocial
        run: |
          echo "Waiting for GoToSocial to start..."
          for i in {1..60}; do
            if curl -s http://localhost:8081 > /dev/null; then
              echo "GoToSocial is up!"
              exit 0
            fi
            sleep 1
          done
          echo "GoToSocial failed to start within 60 seconds"
          docker compose logs
          exit 1

      - name: Create GoToSocial Admin User
        run: |
          # Use docker exec to create user in the running container
          docker compose exec -T gotosocial /gotosocial/gotosocial \
            admin account create \
            --username admin \
            --email admin@example.com \
            --password 'StrongPassword123!' || echo "Admin user may already exist"
          
          # Fix database permissions for test access
          sudo chmod 666 gotosocial_data/sqlite.db || true
          sudo chmod 666 gotosocial_data/sqlite.db-shm || true
          sudo chmod 666 gotosocial_data/sqlite.db-wal || true

      - name: Run Tests
        run: |
          # Start Backend
          cd apps/backend
          deno task start &
          BACKEND_PID=$!
          cd ../..

          # Start Aggregator
          cd apps/aggregator
          deno task start &
          AGGREGATOR_PID=$!
          cd ../..
          
          echo "Waiting for services..."
          timeout 30s bash -c 'until curl -s -o /dev/null http://localhost:8080; do sleep 1; done'
          timeout 30s bash -c 'until curl -s -o /dev/null http://localhost:8082; do sleep 1; done'
          
          # Run unit tests
          cd apps/backend
          deno task test
          
          # Run E2E tests
          deno task test:e2e
          
          # Cleanup
          kill $BACKEND_PID || true
          kill $AGGREGATOR_PID || true
